syntax = "proto3";

package meta.v1;

option go_package = "github.com/jumppad-labs/polymorph/pkg/api/meta/v1;metaapi";

// NOTE: Resource and Field definitions must stay in sync with:
// - heimdall/api/observer/v1/observer.proto
// TODO: Refactor to use shared proto module

// PolymorphMetaService provides metadata APIs for Polymorph services
service PolymorphMetaService {
  // GetResources returns resource schemas for all services on this node
  rpc GetResources(GetResourcesRequest) returns (GetResourcesResponse) {}

  // GetRequestLogs returns recent HTTP request logs for a service
  rpc GetRequestLogs(GetRequestLogsRequest) returns (GetRequestLogsResponse) {}
}

// GetResourcesRequest requests resource metadata
message GetResourcesRequest {
  // Optional: filter by specific service name
  string service_name = 1;

  // RPC forwarding path (for multi-hop routing)
  repeated string path = 2;

  // Current position in the path
  int32 current_hop = 3;
}

// GetResourcesResponse contains resource schemas
message GetResourcesResponse {
  repeated ServiceResources services = 1;
}

// ServiceResources contains resources for a single service
message ServiceResources {
  string service_name = 1;
  repeated Resource resources = 2;
}

// Resource represents a data resource (table/collection)
message Resource {
  string name = 1;           // Resource name (e.g., "user", "order")
  int32 row_count = 2;       // Number of rows/records
  repeated Field fields = 3; // Field schema
  string plural_name = 4;    // Plural form for endpoint (e.g., "users", "orders")
}

// Field represents a field/column in a resource
message Field {
  string name = 1;           // Field name
  string type = 2;           // Field type (uuid, name, email, int, etc.)
  repeated string values = 3; // Enum values (if type is enum)
  optional double min = 4;   // Min value (for numeric types)
  optional double max = 5;   // Max value (for numeric types)
}

// GetRequestLogsRequest requests recent request logs
message GetRequestLogsRequest {
  // Service name to get logs for
  string service_name = 1;

  // Return logs with sequence > after_sequence (0 = all logs)
  uint64 after_sequence = 2;

  // Maximum number of logs to return (default: 100)
  int32 limit = 3;

  // RPC forwarding path (for multi-hop routing)
  repeated string path = 4;

  // Current position in the path
  int32 current_hop = 5;
}

// GetRequestLogsResponse contains request logs
message GetRequestLogsResponse {
  repeated RequestLog logs = 1;
  uint64 latest_sequence = 2; // Most recent sequence number
}

// RequestLog represents a single HTTP request
message RequestLog {
  uint64 sequence = 1;        // Monotonically increasing sequence number
  int64 timestamp = 2;        // Unix timestamp in milliseconds
  string method = 3;          // HTTP method (GET, POST, etc.)
  string path = 4;            // Request path
  int32 status = 5;           // HTTP status code
  int64 duration_ms = 6;      // Request duration in milliseconds
  string level = 7;           // Log level: "debug", "info", "warn", or "error"
}
